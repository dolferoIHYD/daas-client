<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Material Design Lite -->
    <script src="https://code.getmdl.io/1.1.3/material.min.js"></script>
    <link rel="stylesheet" href="https://code.getmdl.io/1.1.3/material.indigo-pink.min.css">
    <!-- Material Design icon font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="/scripts/sockjs-0.3.4.min.js"></script>
    <script src="/scripts/vertxbus.js"></script>
    <script type="text/javascript">
      var connectToEventBus = function() {
        console.log("connecting to eventbus");
        var eb = new vertx.EventBus("http://52.90.78.153:8080/eventbus");

        if (eb) {
          eb.onopen = function () {
            console.log("opening the socket");
          };
       
          eb.onclose = function () {
            console.log("closing socket");
            window.eb = null;

            setTimeout(connectToEventBus, 5000);
          }; 

          window.eb = eb;
        } 
      }

      connectToEventBus();

      function getFieldValue(field) {
        var element = document.getElementById(field); 
        return element ? element.value : "";
      }

      function submitNewOrder() {
        var fromValue = getFieldValue("fromField");
        var toValue = getFieldValue("toField");
        var commentValue = getFieldValue("commentField");

        var order = {from: fromValue, to: toValue, comment: commentValue};

        console.log("Submitting order", order);
        eb && eb.send("order.create", order, function (order) {
          console.log("Order created ", order);
          $(".new-order").hide();
          $(".waiting-for-courier").css({'display': 'flex'});

          console.log("order.realtime.specific." + order.id);

          eb.registerHandler("order.realtime.specific." + order.id, function(driver) {
            console.log("Driver responded", driver);
            $(".courier-status-waiting").hide();
            $(".courier-status-enroute").show();
          });
        }, function (error) {
          console.log("Failed to create order", error);
        });
      }
    </script>
    <style>
      .waiting-for-courier {
        display: none;
      }

      .courier-status-enroute {
        display: none;
      }

      .waiting-for-courier .mdl-mini-footer {
        position: absolute;
        bottom: 0;
        background-color: rgb(63,81,181);
        color: white;
        width: 100%;
      }

      .waiting-for-courier .mdl-mini-footer {
        position: absolute;
        bottom: 0;
        background-color: rgb(63,81,181);
        color: white;
        width: 100%;
        box-sizing: border-box;   
      }

      .waiting-for-courier .mdl-mini-footer__middle-section{
        width: 100%;
        text-align: center;
        font-size: 1.5em;
      }
    </style>
  </head>
  <body>
    <!-- Always shows a header, even in smaller screens. -->
    <div class="mdl-layout mdl-js-layout mdl-layout--fixed-header new-order">
      <header class="mdl-layout__header">
        <div class="mdl-layout__header-row">
          <!-- Title -->
          <span class="mdl-layout-title">Оформить заказ</span>
        </div>
      </header>
      <main class="mdl-layout__content" style="text-align: center">
        <div class="mdl-textfield mdl-js-textfield">
          <input class="mdl-textfield__input" type="text" id="fromField">
          <label class="mdl-textfield__label" for="sample1">Откуда...</label>
        </div>
        <div class="mdl-textfield mdl-js-textfield">
          <input class="mdl-textfield__input" type="text" id="toField">
          <label class="mdl-textfield__label" for="sample1">Куда...</label>
        </div>
        <div class="mdl-textfield mdl-js-textfield">
          <textarea class="mdl-textfield__input" type="text" rows= "5" id="commentField" ></textarea>
          <label class="mdl-textfield__label" for="sample5">Комментарий...</label>
        </div>
        <!-- Colored raised button -->
        <div style="padding: 10px">
          <button class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored" style="height: 48px; width: 100%;" onclick="submitNewOrder();">
            Сделать заказ
          </button>
        </div>
      </main>
    </div>

    <!-- Always shows a header, even in smaller screens. -->
    <div class="mdl-layout mdl-js-layout mdl-layout--fixed-header waiting-for-courier">
      <header class="mdl-layout__header">
        <div class="mdl-layout__header-row">
          <!-- Title -->
          <span class="mdl-layout-title" align="center">Ожидание курьера</span>
        </div>
      </header>
      <main class="mdl-layout__content">
        <div class="courier-status-waiting">
          <div class="mdl-spinner mdl-js-spinner is-active"></div>
        </div>
      </main>
      <footer class="mdl-mini-footer">
        <div class="mdl-mini-footer__middle-section">
          <span class="courier-status-waiting">Подождите, идет поиск курьера.</span>
          <span class="courier-status-enroute">Курьер в пути</span>
        </div>
      </footer>
    </div>
  </body>
</html>
