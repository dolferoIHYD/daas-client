<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Material Design Lite -->
    <script src="https://code.getmdl.io/1.1.3/material.min.js"></script>
    <link rel="stylesheet" href="https://code.getmdl.io/1.1.3/material.indigo-pink.min.css">
    <!-- Material Design icon font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="/scripts/sockjs-0.3.4.min.js"></script>
    <script src="/scripts/vertxbus.js"></script>
    <script type="text/javascript">
      var lastOrder = null;

      var connectToEventBus = function() {
        console.log("connecting to eventbus");
        var eb = new vertx.EventBus("http://52.90.78.153:8080/eventbus");

        if (eb) {
          eb.onopen = function () {
            console.log("opening the socket");
          };
       
          eb.onclose = function () {
            console.log("closing socket");
            window.eb = null;

            setTimeout(connectToEventBus, 5000);
          }; 

          window.eb = eb;
        } 
      }

      connectToEventBus();

      function getFieldValue(field) {
        var element = document.getElementById(field); 
        return element ? element.value : "";
      }

      function orderStatusUpdateHandler(order) {
        console.log("Driver responded", order);

        lastOrder = order;
        
        switch (order.status) {
          case "captured":
            $(".courier-status-list li.courier-status-captured").removeClass("in-progress");
            $(".courier-status-list li.courier-status-captured").addClass("completed");
            $(".courier-status-list li.courier-status-enroute").addClass("in-progress");
            break;
          case "enroute":
            $(".courier-status-list li.courier-status-enroute").removeClass("in-progress");
            $(".courier-status-list li.courier-status-enroute").addClass("completed");
            $(".courier-status-list li.courier-status-pickedup").addClass("in-progress");
            break;
          case "pickedup":
            $(".courier-status-list li.courier-status-pickedup").removeClass("in-progress");
            $(".courier-status-list li.courier-status-pickedup").addClass("completed");
            $(".courier-status-list li.courier-status-delivering").addClass("in-progress");
            break;
          case "delivering":
            $(".courier-status-list li.courier-status-delivering").removeClass("in-progress");
            $(".courier-status-list li.courier-status-delivering").addClass("completed");
            $(".courier-status-list li.courier-status-delivered").addClass("in-progress");
            break;
          case "delivered":
            $(".courier-status-list li.courier-status-delivered").removeClass("in-progress");
            $(".courier-status-list li.courier-status-delivered").addClass("completed");
            $(".courier-status-list li.courier-status-finish").addClass("completed");
            break;
        }
      }

      function submitNewOrder() {
        var fromValue = getFieldValue("fromField");
        var toValue = getFieldValue("toField");
        var commentValue = getFieldValue("commentField");

        var order = {from: fromValue, to: toValue, comment: commentValue};

        console.log("Submitting order", order);
        eb && eb.send("order.create", order, function (order) {
          console.log("Order created ", order);

          lastOrder = order;

          $(".new-order").hide();
          $(".waiting-for-courier #orderId").text(lastOrder.id);
          $(".waiting-for-courier").css({'display': 'flex'});

          console.log("order.realtime.specific." + order.id);

          eb.registerHandler("order.realtime.specific." + order.id, orderStatusUpdateHandler);
        }, function (error) {
          console.log("Failed to create order", error);
        });
      }

      function backToOrderForm() {
        console.log("Returning to order form");

        $(".waiting-for-courier").hide();
        $(".waiting-for-courier .courier-status-list .mdl-list__item").removeClass("completed in-progress");
        $(".waiting-for-courier .courier-status-list .mdl-list__item.courier-status-pending").addClass("completed");
        $(".waiting-for-courier .courier-status-list .mdl-list__item.courier-status-captured").addClass("in-progress");

        if (lastOrder && lastOrder.id) {
          eb.unregisterHandler("order.realtime.specific." + lastOrder.id, orderStatusUpdateHandler);
        }

        $("#fromField").val("");
        $("#toField").val("");
        $("#commentField").val("");
        $(".new-order").css({'display': 'flex'});
      }
    </script>
    <style>
      .waiting-for-courier {
        display: none;
      }

      .waiting-for-courier .mdl-mini-footer {
        position: absolute;
        bottom: 0;
        background-color: rgb(63,81,181);
        color: white;
        width: 100%;
      }

      .waiting-for-courier .mdl-mini-footer {
        position: absolute;
        bottom: 0;
        background-color: rgb(63,81,181);
        color: white;
        width: 100%;
        box-sizing: border-box;   
      }

      .courier-status-list .material-icons {
        display: none;
      }

      .courier-status-list .mdl-list__item-secondary-action {
        width: 24px;
      }

      .courier-status-list .mdl-list__item.completed .material-icons.completed {
        color: #4CAF50;
        display: initial;
      }

      .courier-status-list .mdl-list__item.completed .material-icons.in-progress {
        display: none;
      }

      .courier-status-list .mdl-list__item.in-progress .material-icons.completed {
        display: none;
      }

      .courier-status-list .mdl-list__item.in-progress .material-icons.in-progress {
        color: #FF9800;
        display: initial;
      }

      .courier-status-list .mdl-list__item.completed .mdl-list__item-primary-content {
        color: #BDBDBD;
      }

      .courier-status-list .mdl-list__item.courier-status-finish {
        display: none;
      }

      .courier-status-list .mdl-list__item.courier-status-finish.completed {
        width: 100%;
        display: block;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <!-- Always shows a header, even in smaller screens. -->
    <div class="mdl-layout mdl-layout--fixed-header new-order">
      <header class="mdl-layout__header">
        <div class="mdl-layout__header-row">
          <!-- Title -->
          <span class="mdl-layout-title">Оформить заказ</span>
        </div>
      </header>
      <main class="mdl-grid" style="text-align: center">
        <div class="mdl-cell mdl-cell--12-col">
          <div class="mdl-textfield mdl-js-textfield mdl-textfield--full-width">
            <input class="mdl-textfield__input" type="text" id="fromField">
            <label class="mdl-textfield__label" for="sample1">Откуда...</label>
          </div>
        </div>
        <div class="mdl-cell mdl-cell--12-col">
          <div class="mdl-textfield mdl-js-textfield mdl-textfield--full-width">
            <input class="mdl-textfield__input" type="text" id="toField">
            <label class="mdl-textfield__label" for="sample1">Куда...</label>
          </div>
        </div>
        <div class="mdl-cell mdl-cell--12-col">
          <div class="mdl-textfield mdl-js-textfield mdl-textfield--full-width">
            <textarea class="mdl-textfield__input" type="text" rows= "10" id="commentField" ></textarea>
            <label class="mdl-textfield__label" for="sample5">Комментарий...</label>
          </div>
        </div>
        <!-- Colored raised button -->
        <div class="mdl-cell mdl-cell--12-col" style="padding: 10px;">
          <button class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored" style="height: 48px; width: 100%;" onclick="submitNewOrder();">
            Сделать заказ
          </button>
        </div>
      </main>
    </div>

    <!-- Always shows a header, even in smaller screens. -->
    <div class="mdl-layout mdl-layout--fixed-header waiting-for-courier">
      <header class="mdl-layout__header">
        <div class="mdl-layout-icon" onclick="backToOrderForm();"><i class="material-icons" style="font-size: 2.4em">navigate_before</i></div>
        <div class="mdl-layout__header-row">
          <!-- Title -->
          <span class="mdl-layout-title" align="center">Статус доставки №<span id="orderId"></span></span>
        </div>
      </header>
      <main class="mdl-layout__content">
        <ul class="demo-list-control mdl-list courier-status-list">
          <li class="mdl-list__item courier-status-pending completed">
            <span class="mdl-list__item-primary-content">Ожидание ответа</span>
            <span class="mdl-list__item-secondary-action">
              <i class="material-icons completed">check circle</i>
            </span>
          </li>
          <li class="mdl-list__item courier-status-captured in-progress">
            <span class="mdl-list__item-primary-content">Заказ принят</span>
            <span class="mdl-list__item-secondary-action">
              <i class="material-icons in-progress">schedule</i>
              <i class="material-icons completed">check circle</i>
            </span>
          </li>
          <li class="mdl-list__item courier-status-enroute">
            <span class="mdl-list__item-primary-content">Курьер в пути</span>
            <span class="mdl-list__item-secondary-action">
              <i class="material-icons in-progress">schedule</i>
              <i class="material-icons completed">check circle</i>
            </span>
          </li>
          <li class="mdl-list__item courier-status-pickedup">
            <span class="mdl-list__item-primary-content">Посылка у курьера</span>
            <span class="mdl-list__item-secondary-action">
              <i class="material-icons in-progress">schedule</i>
              <i class="material-icons completed">check circle</i>
            </span>
          </li>
          <li class="mdl-list__item courier-status-delivering">
            <span class="mdl-list__item-primary-content">Посылка в пути</span>
            <span class="mdl-list__item-secondary-action">
              <i class="material-icons in-progress">schedule</i>
              <i class="material-icons completed">check circle</i>
            </span>
          </li>
          <li class="mdl-list__item courier-status-delivered">
            <span class="mdl-list__item-primary-content">Посылка доставлена</span>
            <span class="mdl-list__item-secondary-action">
              <i class="material-icons in-progress">schedule</i>
              <i class="material-icons completed">check circle</i>
            </span>
          </li>
          <li class="mdl-list__item courier-status-finish">
            <img src="/images/checkered-flag.gif">
          </li>
        </ul>
      </main>
    </div>
  </body>
</html>
