<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">	
		<meta name="viewport" content="width=device-width, initial-scale=1">
	
		<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Roboto:300,400,500,700" type="text/css">
		<!-- Material Design Lite -->
		<script src="https://code.getmdl.io/1.1.3/material.min.js"></script>
		<link rel="stylesheet" href="https://code.getmdl.io/1.1.3/material.indigo-pink.min.css">
		<!-- Material Design icon font -->
		<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">

		
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
		<script src="/scripts/sockjs-0.3.4.min.js"></script>
		<script src="/scripts/vertxbus.js"></script>

		<title>Courier's list</title>

		
		<script>
			var order;
	   		var eb = new vertx.EventBus("http://52.90.78.153:8080/eventbus");
	   		eb.onopen = function () {
	       		console.log("opening the socket");
	       		eb.registerHandler("order.realtime", function (msg) {
	           	//	console.log("recieving the message " + msg.status + msg.id);
	           	//	console.log(JSON.stringify(msg));
	           		var object = $("<li class='mdl-list__item mdl-list__item--two-line listyl' data-order-id='"	+ msg.id + "'>"
	           		+   "<span class='mdl-list__item-primary-content'>" 
	           		+     "<i class='material-icons'>location_on</i>"
	           		+     "<span>" + msg.from + "</span>" 
	           		+     "<span class='mdl-list__item-sub-title'>" + "\tСтатус: " + msg.status + "</span>" 
	           		+   "</span>" 
	           		+ "</li>");

	           		switch(msg.status) {
	           			case "pending":
	           				object.click( function() {
	           					order = msg; 
       							$(".orders").hide();
       							$(".order-status").css({'display': 'flex'}); 
       						});
       						object.addClass("pending");
	           				$("ul.orders-list").prepend(object);
	           				break;	

						default:
							object.addClass("not-pending");
							$(object).removeClass("listyl");
							$("li[data-order-id='"+msg.id+"']").replaceWith(object);

							break;           		
	           		}
	       		});
	   		};
   		
	   		eb.onclose = function () {
	       		console.log("closing socket");
	       		eb = null;
  			};
        
			function changeOrderStatusToCaptured() {
				order.status = "captured";
				eb && eb.send("order.action", order); 
				console.log(order.id, order.status);    
			};

			function changeOrderStatusToEnroute() {
				order.status = "enroute";
				eb && eb.send("order.action", order);
				console.log(order.id, order.status); 
			};

			function changeOrderStatusToPickedUp() {
				order.status = "pickedup";
				eb && eb.send("order.action", order);
				console.log(order.id, order.status); 
			};

			function changeOrderStatusToDelivering() {
				order.status = "delivering";
				eb && eb.send("order.action", order);
				console.log(order.id, order.status); 
			};

			function changeOrderStatusToDelivered() {
				order.status = "delivered";
				eb && eb.send("order.action", order);
				console.log(order.id, order.status); 
			};
		</script>
		<style>
		
			.mdl-list__item-sub-title {
				color: inherit;			
			}
			
			 .listyl .mdl-list__item-sub-title{
					color: black;			 
			 }
			
			.demo-list-two {
  				width: 300px;
			}
			
			a.fill-div {
   			display: block;
    			height: 100%;
    			width: 100%;
    			text-decoration: none;
			}
			
			.not-pending{
				color: grey;			
			}
			
			.pending{
				color: black;			
			}
			
			.order-status{
				display: none;			
			}
		</style>
	</head>
	<body>
		<!-- Always shows a header, even in smaller screens. -->
		<div class="mdl-layout mdl-layout--fixed-header orders">
			<header class="mdl-layout__header">
				<div class="mdl-layout__header-row">
					<!-- Title -->
					<span class="mdl-layout-title" align="center">Заказы</span>
					<!-- Add spacer, to align navigation to the right -->
					<div class="mdl-layout-spacer"></div>
				</div>
			</header>
			
			<ul class="demo-list-two mdl-list orders-list"></ul>
		</div>
		
		    <!-- Always shows a header, even in smaller screens. -->
	    <div class="mdl-layout mdl-layout--fixed-header order-status">
	      <header class="mdl-layout__header">
	        <div class="mdl-layout__header-row">
	          <!-- Title -->
	          <span class="mdl-layout-title" align="center">Доставка</span>
	        </div>
	      </header>
	      <main class="mdl-layout__content">
	        <ul class="demo-list-control mdl-list courier-status-list">
	          <li onclick="changeOrderStatusToCaptured()" class="mdl-list__item courier-status-pending completed">
	            <span class="mdl-list__item-primary-content">Заказ принял</span>
	            <span class="mdl-list__item-secondary-action">
	              <i class="material-icons completed">check circle</i>
	            </span>
	          </li>
	          <li onclick="changeOrderStatusToEnroute()" class="mdl-list__item courier-status-captured in-progress">
	            <span class="mdl-list__item-primary-content">Выехал на заказ</span>
	            <span class="mdl-list__item-secondary-action">
	              <i class="material-icons completed">check circle</i>
	            </span>
	          </li>
	          <li onclick="changeOrderStatusToPickedUp()" class="mdl-list__item courier-status-enroute">
	            <span class="mdl-list__item-primary-content">Подобрал посылку</span>
	            <span class="mdl-list__item-secondary-action">
	              <i class="material-icons completed">check circle</i>
	            </span>
	          </li>
	          <li onclick="changeOrderStatusToDelivering()" class="mdl-list__item courier-status-pickedup">
	            <span class="mdl-list__item-primary-content">Выехал к получателю</span>
	            <span class="mdl-list__item-secondary-action">
	              <i class="material-icons completed">check circle</i>
	            </span>
	          </li>
	          <li onclick="changeOrderStatusToDelivered()" class="mdl-list__item courier-status-delivering">
	            <span class="mdl-list__item-primary-content">Передал получателю</span>
	            <span class="mdl-list__item-secondary-action">
	              <i class="material-icons completed">check circle</i>
	            </span>
	          </li>
	        </ul>
	      </main>
	    </div>
	</body>
</html>